# J05 实验报告

## 1. 扩展内容

本次实验在原有游戏基础上进行了以下扩展：

1. **场景切换**：增加了主菜单场景、游戏主场景、游戏结束场景，实现了场景之间的切换。

2. **实体唯一标识系统**：为敌人（Enemy）、AI玩家（AIPlayer）和子弹对象（EnemyBullet、PlayerBullet）添加了uniqueId字段，确保在回放过程中能够准确识别和跟踪每个实体对象。

3. **实体类型持久化机制**：实现了对象类型映射系统，确保在回放过程中实体类型的一致性，避免类型混淆导致的渲染错误。

4. **高级实体匹配算法**：设计了基于实体键的匹配系统，优先使用uniqueId进行实体匹配，对于子弹等临时对象使用位置信息辅助匹配，提高回放精度。

## 2. 实现存档与回放

### 2.1 录制系统实现

录制系统通过RecordingService类实现，主要功能包括：

1. **关键帧记录**：在游戏运行过程中定期记录游戏状态，生成包含所有实体信息的关键帧。

2. **唯一标识符添加**：在writeKeyframe方法中，为特定类型的对象（Enemy、AIPlayer、EnemyBullet、PlayerBullet）添加uniqueId字段到JSON数据中，确保回放时能够准确匹配实体。

3. **JSONL格式存储**：使用JSONL格式（每行一个JSON对象）存储录制数据，便于高效读写和处理大型录制文件。

### 2.2 回放系统实现

回放系统通过ReplayScene类实现，核心功能包括：

1. **实体构建**：在buildObjectFromEntity方法中，根据实体类型创建不同的GameObject对象，为敌人创建矩形渲染组件，为子弹创建圆形渲染组件，并设置相应的尺寸和颜色。

2. **实体键生成**：实现了getEntityKey方法，为不同类型的实体生成唯一的匹配键，确保在两个关键帧之间正确匹配相同的实体。

3. **插值位置更新**：在updateInterpolatedPositions方法中，实现了基于实体键的双向映射系统，能够处理实体在不同关键帧中的存在状态变化，并进行平滑的位置插值。

## 3. 存在的问题及后续方向

### 3.1 已解决的问题

1. **子弹回放不显示问题**：通过为子弹对象添加特殊的渲染逻辑和唯一标识符，成功解决了子弹在回放过程中不显示的问题。

### 3.2 存在的问题

1. **渲染异常**：子弹的模型被渲染成了Enemy的模型，导致视觉上的错误。

### 3.3 后续优化方向

1. **性能优化**：采用更高效的数据结构和算法，减少实体匹配和插值计算的时间复杂度。

2. **录制数据压缩**：实现录制数据的压缩算法，减少存储空间占用，支持更长时间的游戏录制。